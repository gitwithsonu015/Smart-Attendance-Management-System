{"ast":null,"code":"const express = require('express');\nconst jwt = require('jsonwebtoken');\nconst Attendance = require('../models/Attendance');\nconst Student = require('../models/Student');\nconst Faculty = require('../models/Faculty');\nconst QRCode = require('qrcode');\nconst router = express.Router();\n\n// Middleware to verify token\nconst verifyToken = (req, res, next) => {\n  const token = req.header('Authorization');\n  if (!token) return res.status(401).json({\n    error: 'Access denied'\n  });\n  try {\n    const verified = jwt.verify(token, process.env.JWT_SECRET);\n    req.user = verified;\n    next();\n  } catch (err) {\n    res.status(400).json({\n      error: 'Invalid token'\n    });\n  }\n};\n\n// Generate QR Code for attendance\nrouter.post('/generate-qr', verifyToken, async (req, res) => {\n  if (req.user.role !== 'faculty') return res.status(403).json({\n    error: 'Access denied'\n  });\n  const {\n    className\n  } = req.body;\n  try {\n    const qrData = JSON.stringify({\n      class: className,\n      facultyId: req.user.id,\n      timestamp: Date.now()\n    });\n    const qrCode = await QRCode.toDataURL(qrData);\n    res.json({\n      qrCode\n    });\n  } catch (err) {\n    res.status(500).json({\n      error: err.message\n    });\n  }\n});\n\n// Mark attendance via QR scan\nrouter.post('/mark', verifyToken, async (req, res) => {\n  if (req.user.role !== 'student') return res.status(403).json({\n    error: 'Access denied'\n  });\n  const {\n    qrData\n  } = req.body;\n  try {\n    const {\n      class: className,\n      facultyId\n    } = JSON.parse(qrData);\n    const attendance = new Attendance({\n      student: req.user.id,\n      class: className,\n      markedBy: facultyId\n    });\n    await attendance.save();\n\n    // Add to student's attendance\n    await Student.findByIdAndUpdate(req.user.id, {\n      $push: {\n        attendance: attendance._id\n      }\n    });\n    res.json({\n      message: 'Attendance marked successfully'\n    });\n  } catch (err) {\n    res.status(500).json({\n      error: err.message\n    });\n  }\n});\n\n// Get attendance records for faculty\nrouter.get('/records', verifyToken, async (req, res) => {\n  if (req.user.role !== 'faculty') return res.status(403).json({\n    error: 'Access denied'\n  });\n  try {\n    const records = await Attendance.find({\n      markedBy: req.user.id\n    }).populate('student');\n    res.json(records);\n  } catch (err) {\n    res.status(500).json({\n      error: err.message\n    });\n  }\n});\n\n// Generate report\nrouter.get('/report', verifyToken, async (req, res) => {\n  if (req.user.role !== 'faculty') return res.status(403).json({\n    error: 'Access denied'\n  });\n  try {\n    const records = await Attendance.find({\n      markedBy: req.user.id\n    }).populate('student');\n    // Simple report generation (can be enhanced)\n    const report = records.reduce((acc, record) => {\n      const studentId = record.student._id.toString();\n      if (!acc[studentId]) {\n        acc[studentId] = {\n          name: record.student.name,\n          present: 0,\n          total: 0\n        };\n      }\n      acc[studentId].total++;\n      if (record.status === 'present') acc[studentId].present++;\n      return acc;\n    }, {});\n    res.json(report);\n  } catch (err) {\n    res.status(500).json({\n      error: err.message\n    });\n  }\n});\nmodule.exports = router;","map":{"version":3,"names":["express","require","jwt","Attendance","Student","Faculty","QRCode","router","Router","verifyToken","req","res","next","token","header","status","json","error","verified","verify","process","env","JWT_SECRET","user","err","post","role","className","body","qrData","JSON","stringify","class","facultyId","id","timestamp","Date","now","qrCode","toDataURL","message","parse","attendance","student","markedBy","save","findByIdAndUpdate","$push","_id","get","records","find","populate","report","reduce","acc","record","studentId","toString","name","present","total","module","exports"],"sources":["C:/Users/HP/Desktop/smart attendance/client/src/routes/attendance.js"],"sourcesContent":["const express = require('express');\r\nconst jwt = require('jsonwebtoken');\r\nconst Attendance = require('../models/Attendance');\r\nconst Student = require('../models/Student');\r\nconst Faculty = require('../models/Faculty');\r\nconst QRCode = require('qrcode');\r\n\r\nconst router = express.Router();\r\n\r\n// Middleware to verify token\r\nconst verifyToken = (req, res, next) => {\r\n  const token = req.header('Authorization');\r\n  if (!token) return res.status(401).json({ error: 'Access denied' });\r\n\r\n  try {\r\n    const verified = jwt.verify(token, process.env.JWT_SECRET);\r\n    req.user = verified;\r\n    next();\r\n  } catch (err) {\r\n    res.status(400).json({ error: 'Invalid token' });\r\n  }\r\n};\r\n\r\n// Generate QR Code for attendance\r\nrouter.post('/generate-qr', verifyToken, async (req, res) => {\r\n  if (req.user.role !== 'faculty') return res.status(403).json({ error: 'Access denied' });\r\n\r\n  const { className } = req.body;\r\n  try {\r\n    const qrData = JSON.stringify({ class: className, facultyId: req.user.id, timestamp: Date.now() });\r\n    const qrCode = await QRCode.toDataURL(qrData);\r\n    res.json({ qrCode });\r\n  } catch (err) {\r\n    res.status(500).json({ error: err.message });\r\n  }\r\n});\r\n\r\n// Mark attendance via QR scan\r\nrouter.post('/mark', verifyToken, async (req, res) => {\r\n  if (req.user.role !== 'student') return res.status(403).json({ error: 'Access denied' });\r\n\r\n  const { qrData } = req.body;\r\n  try {\r\n    const { class: className, facultyId } = JSON.parse(qrData);\r\n    const attendance = new Attendance({\r\n      student: req.user.id,\r\n      class: className,\r\n      markedBy: facultyId\r\n    });\r\n    await attendance.save();\r\n\r\n    // Add to student's attendance\r\n    await Student.findByIdAndUpdate(req.user.id, { $push: { attendance: attendance._id } });\r\n\r\n    res.json({ message: 'Attendance marked successfully' });\r\n  } catch (err) {\r\n    res.status(500).json({ error: err.message });\r\n  }\r\n});\r\n\r\n// Get attendance records for faculty\r\nrouter.get('/records', verifyToken, async (req, res) => {\r\n  if (req.user.role !== 'faculty') return res.status(403).json({ error: 'Access denied' });\r\n\r\n  try {\r\n    const records = await Attendance.find({ markedBy: req.user.id }).populate('student');\r\n    res.json(records);\r\n  } catch (err) {\r\n    res.status(500).json({ error: err.message });\r\n  }\r\n});\r\n\r\n// Generate report\r\nrouter.get('/report', verifyToken, async (req, res) => {\r\n  if (req.user.role !== 'faculty') return res.status(403).json({ error: 'Access denied' });\r\n\r\n  try {\r\n    const records = await Attendance.find({ markedBy: req.user.id }).populate('student');\r\n    // Simple report generation (can be enhanced)\r\n    const report = records.reduce((acc, record) => {\r\n      const studentId = record.student._id.toString();\r\n      if (!acc[studentId]) {\r\n        acc[studentId] = { name: record.student.name, present: 0, total: 0 };\r\n      }\r\n      acc[studentId].total++;\r\n      if (record.status === 'present') acc[studentId].present++;\r\n      return acc;\r\n    }, {});\r\n\r\n    res.json(report);\r\n  } catch (err) {\r\n    res.status(500).json({ error: err.message });\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}